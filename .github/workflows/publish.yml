name: publish to crates.io

on:
  push:
    tags:
      - v[0-9]+.[0-9]+.[0-9]+

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3
      - name: Install stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      - name: Extract Tag
        id: tag
        uses: aaronbarnaby/get-tag@v1.0.0
        with:
          without_prefix_v: true
      - run: |
          cargo install cargo-publish-workspace-v2
          cargo publish-workspace -p nova_web --token ${CRATES_TOKEN} --target-version ${{ steps.tag.outputs.tag }}
        env:
          CRATES_TOKEN: ${{ secrets.CRATES_TOKEN }}

  publish-docs:
    name: Publish docs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3
      - name: Install stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
      - name: Build Docs
        run: cargo doc --no-deps --workspace --all-features
        env:
          RUSTDOCFLAGS: --cfg=docsrs
